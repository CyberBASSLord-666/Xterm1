# ============================================================================
# CI/CD Status Dashboard Generator
# ============================================================================
# Generates a status dashboard showing the current state of all workflows
# and publishes it to GitHub Pages.
#
# Features:
# - Real-time workflow status badges
# - Recent run history
# - Performance metrics
# - Failure notifications
#
# Schedule: Runs every 6 hours and on workflow completions
# ============================================================================

name: üìà CI/CD Dashboard

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_run:
    workflows: ["CI", "Security Scan", "Deploy"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  actions: read

concurrency:
  group: dashboard-update
  cancel-in-progress: true

jobs:
  generate-dashboard:
    name: Generate Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Collect workflow status
        id: status
        uses: actions/github-script@v7
        with:
          script: |
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            const workflowStatus = [];
            
            for (const workflow of workflows.workflows) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                per_page: 5
              });
              
              const latestRun = runs.workflow_runs[0];
              
              workflowStatus.push({
                name: workflow.name,
                id: workflow.id,
                state: workflow.state,
                latestRun: latestRun ? {
                  status: latestRun.status,
                  conclusion: latestRun.conclusion,
                  createdAt: latestRun.created_at,
                  updatedAt: latestRun.updated_at,
                  htmlUrl: latestRun.html_url,
                  runNumber: latestRun.run_number
                } : null,
                recentRuns: runs.workflow_runs.slice(0, 5).map(run => ({
                  conclusion: run.conclusion,
                  status: run.status
                }))
              });
            }
            
            return workflowStatus;

      - name: Generate dashboard HTML
        id: html
        uses: actions/github-script@v7
        with:
          script: |
            const status = ${{ steps.status.outputs.result }};
            const repo = '${{ github.repository }}';
            const timestamp = new Date().toISOString();
            
            const getStatusColor = (conclusion) => {
              switch (conclusion) {
                case 'success': return '#22c55e';
                case 'failure': return '#ef4444';
                case 'cancelled': return '#f59e0b';
                case 'skipped': return '#6b7280';
                default: return '#3b82f6';
              }
            };
            
            const getStatusEmoji = (conclusion) => {
              switch (conclusion) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'cancelled': return '‚ö†Ô∏è';
                case 'skipped': return '‚è≠Ô∏è';
                case 'in_progress': return 'üîÑ';
                default: return '‚è≥';
              }
            };
            
            let html = `<!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>CI/CD Dashboard - PolliWall</title>
              <style>
                :root {
                  --bg-primary: #0d1117;
                  --bg-secondary: #161b22;
                  --text-primary: #c9d1d9;
                  --text-secondary: #8b949e;
                  --border-color: #30363d;
                  --success: #22c55e;
                  --failure: #ef4444;
                  --warning: #f59e0b;
                  --info: #3b82f6;
                }
                
                * { box-sizing: border-box; margin: 0; padding: 0; }
                
                body {
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
                  background: var(--bg-primary);
                  color: var(--text-primary);
                  line-height: 1.6;
                  padding: 2rem;
                }
                
                .container {
                  max-width: 1200px;
                  margin: 0 auto;
                }
                
                header {
                  text-align: center;
                  margin-bottom: 2rem;
                  padding-bottom: 1rem;
                  border-bottom: 1px solid var(--border-color);
                }
                
                h1 {
                  font-size: 2rem;
                  margin-bottom: 0.5rem;
                }
                
                .subtitle {
                  color: var(--text-secondary);
                  font-size: 0.9rem;
                }
                
                .grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                  gap: 1rem;
                }
                
                .card {
                  background: var(--bg-secondary);
                  border: 1px solid var(--border-color);
                  border-radius: 8px;
                  padding: 1rem;
                }
                
                .card-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 0.75rem;
                }
                
                .card-title {
                  font-size: 1rem;
                  font-weight: 600;
                }
                
                .status-badge {
                  padding: 0.25rem 0.75rem;
                  border-radius: 9999px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  text-transform: uppercase;
                }
                
                .status-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
                .status-failure { background: rgba(239, 68, 68, 0.2); color: var(--failure); }
                .status-cancelled { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
                .status-pending { background: rgba(59, 130, 246, 0.2); color: var(--info); }
                
                .run-history {
                  display: flex;
                  gap: 0.25rem;
                  margin-top: 0.5rem;
                }
                
                .run-dot {
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                }
                
                .card-footer {
                  margin-top: 0.75rem;
                  padding-top: 0.75rem;
                  border-top: 1px solid var(--border-color);
                  display: flex;
                  justify-content: space-between;
                  font-size: 0.8rem;
                  color: var(--text-secondary);
                }
                
                .card-footer a {
                  color: var(--info);
                  text-decoration: none;
                }
                
                .card-footer a:hover {
                  text-decoration: underline;
                }
                
                footer {
                  text-align: center;
                  margin-top: 2rem;
                  padding-top: 1rem;
                  border-top: 1px solid var(--border-color);
                  color: var(--text-secondary);
                  font-size: 0.8rem;
                }
                
                @media (max-width: 768px) {
                  body { padding: 1rem; }
                  .grid { grid-template-columns: 1fr; }
                }
              </style>
            </head>
            <body>
              <div class="container">
                <header>
                  <h1>üöÄ CI/CD Dashboard</h1>
                  <p class="subtitle">PolliWall (Xterm1) ‚Ä¢ ${repo}</p>
                </header>
                
                <div class="grid">`;
            
            for (const wf of status.sort((a, b) => a.name.localeCompare(b.name))) {
              const conclusion = wf.latestRun?.conclusion || wf.latestRun?.status || 'unknown';
              const statusClass = conclusion === 'success' ? 'status-success' : 
                                  conclusion === 'failure' ? 'status-failure' :
                                  conclusion === 'cancelled' ? 'status-cancelled' : 'status-pending';
              
              html += `
                  <div class="card">
                    <div class="card-header">
                      <span class="card-title">${wf.name}</span>
                      <span class="status-badge ${statusClass}">${getStatusEmoji(conclusion)} ${conclusion || 'pending'}</span>
                    </div>
                    <div class="run-history">
                      ${wf.recentRuns.map(run => 
                        `<div class="run-dot" style="background: ${getStatusColor(run.conclusion || run.status)}" title="${run.conclusion || run.status}"></div>`
                      ).join('')}
                    </div>
                    <div class="card-footer">
                      <span>Run #${wf.latestRun?.runNumber || 'N/A'}</span>
                      ${wf.latestRun?.htmlUrl ? `<a href="${wf.latestRun.htmlUrl}" target="_blank">View Run ‚Üí</a>` : ''}
                    </div>
                  </div>`;
            }
            
            html += `
                </div>
                
                <footer>
                  <p>Last updated: ${timestamp}</p>
                  <p>Auto-generated by CI/CD Dashboard Workflow</p>
                </footer>
              </div>
            </body>
            </html>`;
            
            return html;

      - name: Write dashboard files
        run: |
          mkdir -p dashboard
          cat << 'EOF' > dashboard/index.html
          ${{ steps.html.outputs.result }}
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard
          destination_dir: dashboard
          keep_files: true

      - name: Generate summary
        run: |
          echo "## üìà Dashboard Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The CI/CD status dashboard has been updated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**View Dashboard:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dashboard/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
