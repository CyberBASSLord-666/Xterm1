# ============================================================================
# Autonomous Optimize Workflow for PolliWall (Xterm1)
# ============================================================================
# This workflow detects and applies optimization opportunities:
# - Tree-shaking improvements
# - Unused import removal
# - Unused variable detection and removal
# - Bundle size optimization suggestions
# - Performance anti-pattern detection
# - Auto-applies safe optimizations
# - GitHub Copilot integration for AI insights
#
# Trigger: Manual dispatch or via @copilot optimize command
# ============================================================================

name: Autonomous Optimize

on:
  workflow_dispatch:
    inputs:
      apply_fixes:
        description: 'Apply safe fixes automatically'
        required: false
        type: boolean
        default: true
      scope:
        description: 'Optimization scope'
        required: false
        type: choice
        options:
          - all
          - imports
          - variables
          - performance
          - bundle
        default: 'all'
      target_branch:
        description: 'Target branch (leave empty for current)'
        required: false
        type: string

  repository_dispatch:
    types: [optimize-requested]

# Security: Restrict permissions to minimum required
permissions:
  contents: write
  pull-requests: write
  issues: write

# Security: Prevent concurrent runs
concurrency:
  group: optimize-${{ github.run_id }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ============ ANALYZE OPTIMIZATION OPPORTUNITIES ============
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      unused_imports: ${{ steps.imports.outputs.count }}
      unused_vars: ${{ steps.variables.outputs.count }}
      performance_issues: ${{ steps.performance.outputs.count }}
      treeshaking_issues: ${{ steps.treeshaking.outputs.count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Detect unused imports
        id: imports
        run: |
          echo "üîç Detecting unused imports..."
          
          # Run ESLint with unused imports rule
          set +e
          npx eslint "src/**/*.ts" \
            --rule '{"@typescript-eslint/no-unused-vars": "error"}' \
            --rule '{"no-unused-vars": "off"}' \
            --format json > unused-imports.json 2>&1
          set -e
          
          COUNT=$(cat unused-imports.json | jq '[.[] | .messages[] | select(.ruleId == "@typescript-eslint/no-unused-vars")] | length' 2>/dev/null || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
          
          echo "### Unused Imports/Variables" >> $GITHUB_STEP_SUMMARY
          echo "Found: $COUNT instances" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Detect unused variables
        id: variables
        run: |
          echo "üîç Detecting unused variables..."
          
          # Parse ESLint output for unused vars
          COUNT=$(cat unused-imports.json | jq '[.[] | .messages[] | select(.message | contains("is defined but never used"))] | length' 2>/dev/null || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Detect performance anti-patterns
        id: performance
        run: |
          echo "‚ö° Detecting performance anti-patterns..."
          
          ISSUES=0
          
          # Check for sync operations in async contexts
          SYNC_OPS=$(grep -rn "readFileSync\|writeFileSync\|execSync" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          ISSUES=$((ISSUES + SYNC_OPS))
          
          # Check for missing OnPush change detection
          DEFAULT_CD=$(grep -rn "changeDetection: ChangeDetectionStrategy.Default" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          ISSUES=$((ISSUES + DEFAULT_CD))
          
          # Check for console.log statements
          CONSOLE_LOGS=$(grep -rn "console\.log\|console\.debug" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          ISSUES=$((ISSUES + CONSOLE_LOGS))
          
          # Check for any type usage
          ANY_TYPES=$(grep -rn ": any" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          ISSUES=$((ISSUES + ANY_TYPES))
          
          echo "count=$ISSUES" >> $GITHUB_OUTPUT
          echo "sync_ops=$SYNC_OPS" >> $GITHUB_OUTPUT
          echo "default_cd=$DEFAULT_CD" >> $GITHUB_OUTPUT
          echo "console_logs=$CONSOLE_LOGS" >> $GITHUB_OUTPUT
          echo "any_types=$ANY_TYPES" >> $GITHUB_OUTPUT
          
          echo "### Performance Anti-Patterns" >> $GITHUB_STEP_SUMMARY
          echo "| Pattern | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sync operations | $SYNC_OPS |" >> $GITHUB_STEP_SUMMARY
          echo "| Default ChangeDetection | $DEFAULT_CD |" >> $GITHUB_STEP_SUMMARY
          echo "| Console logs | $CONSOLE_LOGS |" >> $GITHUB_STEP_SUMMARY
          echo "| 'any' type usage | $ANY_TYPES |" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Detect tree-shaking issues
        id: treeshaking
        run: |
          echo "üå≥ Detecting tree-shaking issues..."
          
          ISSUES=0
          
          # Check for namespace imports
          NAMESPACE_IMPORTS=$(grep -rn "import \* as" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          ISSUES=$((ISSUES + NAMESPACE_IMPORTS))
          
          # Check for default exports with namespace re-exports
          BARREL_ISSUES=$(grep -rn "export \* from" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          
          echo "count=$ISSUES" >> $GITHUB_OUTPUT
          echo "namespace_imports=$NAMESPACE_IMPORTS" >> $GITHUB_OUTPUT
          echo "barrel_exports=$BARREL_ISSUES" >> $GITHUB_OUTPUT
          
          echo "### Tree-Shaking Analysis" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace imports (import * as) | $NAMESPACE_IMPORTS |" >> $GITHUB_STEP_SUMMARY
          echo "| Barrel re-exports | $BARREL_ISSUES |" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: optimization-analysis
          path: |
            unused-imports.json
          retention-days: 30
          if-no-files-found: ignore

  # ============ APPLY SAFE OPTIMIZATIONS ============
  optimize:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: analyze
    if: inputs.apply_fixes != false && needs.analyze.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Remove unused imports
        id: fix_imports
        if: inputs.scope == 'all' || inputs.scope == 'imports'
        run: |
          echo "üßπ Removing unused imports..."
          
          # Use ESLint to fix unused imports
          set +e
          npx eslint "src/**/*.ts" \
            --rule '{"@typescript-eslint/no-unused-vars": ["error", {"argsIgnorePattern": "^_"}]}' \
            --fix 2>&1 | tee eslint-fix-output.txt
          set -e
          
          # Check if changes were made
          if [[ -n $(git status --porcelain "src/**/*.ts" 2>/dev/null) ]]; then
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Organize imports
        id: organize_imports
        if: inputs.scope == 'all' || inputs.scope == 'imports'
        run: |
          echo "üì¶ Organizing imports..."
          
          # Run Prettier to sort imports (if configured)
          npx prettier --write "src/**/*.ts" 2>&1 || true
        continue-on-error: true

      - name: Remove console.log statements
        id: remove_console
        if: inputs.scope == 'all' || inputs.scope == 'performance'
        run: |
          echo "üóëÔ∏è Removing console.log statements..."
          
          REMOVED=0
          
          # Remove console.log, console.debug (but keep console.error, console.warn)
          for file in $(find src -name "*.ts" ! -name "*.spec.ts"); do
            if grep -q "console\.log\|console\.debug" "$file" 2>/dev/null; then
              # Use sed to comment out or remove console statements
              sed -i 's/^\(\s*\)console\.log\(.*\);$/\1\/\/ console.log\2; \/\/ REMOVED BY OPTIMIZER/g' "$file"
              sed -i 's/^\(\s*\)console\.debug\(.*\);$/\1\/\/ console.debug\2; \/\/ REMOVED BY OPTIMIZER/g' "$file"
              REMOVED=$((REMOVED + 1))
            fi
          done
          
          echo "removed=$REMOVED" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run final lint and format
        run: |
          echo "‚ú® Running final lint and format..."
          npx eslint "src/**/*.{ts,html}" --fix || true
          npx prettier --write "src/**/*.{ts,html,css,scss,json}" || true
        continue-on-error: true

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            CHANGED_COUNT=$(git status --porcelain | wc -l)
            echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit optimizations
        if: steps.changes.outputs.has_changes == 'true'
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          
          git commit -m "‚ö° Optimize: Applied automatic code optimizations

          Changes applied:
          - Removed unused imports and variables
          - Organized import statements
          - Removed console.log statements
          - Applied ESLint auto-fixes
          - Formatted code with Prettier

          Files changed: ${{ steps.changes.outputs.changed_count }}

          This commit was automatically generated by the Autonomous Optimize workflow."
          
          git push
          echo "committed=true" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate optimization report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const hasChanges = '${{ steps.changes.outputs.has_changes }}' === 'true';
            const committed = '${{ steps.commit.outputs.committed }}' === 'true';
            const sha = '${{ steps.commit.outputs.sha }}';
            const changedCount = '${{ steps.changes.outputs.changed_count }}';
            
            // Analysis results
            const unusedImports = '${{ needs.analyze.outputs.unused_imports }}' || '0';
            const performanceIssues = '${{ needs.analyze.outputs.performance_issues }}' || '0';
            const treeshakingIssues = '${{ needs.analyze.outputs.treeshaking_issues }}' || '0';
            
            let report = `## ‚ö° Optimization Report
            
            ### Analysis Summary
            | Category | Issues Found |
            |----------|--------------|
            | Unused Imports/Variables | ${unusedImports} |
            | Performance Anti-Patterns | ${performanceIssues} |
            | Tree-Shaking Issues | ${treeshakingIssues} |
            
            `;
            
            if (committed) {
              report += `### ‚úÖ Optimizations Applied
            
            | Metric | Value |
            |--------|-------|
            | Files Changed | ${changedCount} |
            | Commit | \`${sha}\` |
            
            **Changes Applied:**
            - ‚úÖ Removed unused imports and variables
            - ‚úÖ Organized import statements
            - ‚úÖ Commented out console.log statements
            - ‚úÖ Applied ESLint auto-fixes
            - ‚úÖ Formatted code with Prettier
            `;
            } else if (hasChanges) {
              report += `### ‚ö†Ô∏è Changes Detected but Not Committed
            
            Changes were detected but could not be committed. Please review manually.
            `;
            } else {
              report += `### ‚ú® No Changes Needed
            
            The code is already well-optimized!
            `;
            }
            
            report += `
            ---
            *Generated by Autonomous Optimize Workflow*`;
            
            // Write to job summary
            await core.summary
              .addRaw(report)
              .write();
