# =============================================================================
# Security Scanning Workflow for PolliWall (Xterm1)
# =============================================================================
# This workflow performs comprehensive security analysis including:
# - Dependency vulnerability scanning (npm audit)
# - Code security analysis (CodeQL)
# - Dependency review for pull requests
#
# Schedule: Weekly on Sundays at midnight UTC
#
# Jobs:
# - dependency-review: GitHub dependency review for PRs
# - npm-audit: npm vulnerability scanning
# - codeql: GitHub CodeQL security analysis
#
# SECURITY NOTES:
# - This workflow runs on push/PR to main branch and on a weekly schedule
# - It has minimal permissions following least-privilege principle
# - Security events are uploaded to GitHub Security tab
# - npm audit runs with --audit-level=high to catch critical issues
#
# This workflow is part of the Agentic Swarm system and coordinates with:
# - security-guardian agent for vulnerability management
# - auto-fix-all.yml for automatic security fixes
# - swarm-coordinator.yml for orchestration
# =============================================================================

name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday

# Security: Explicit permissions following least privilege principle
permissions:
  contents: read
  security-events: write
  actions: read

# Concurrency: Prevent multiple security scans from running simultaneously
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # DEPENDENCY REVIEW JOB
  # ============================================================================
  # Purpose: Reviews dependency changes for vulnerabilities in pull requests
  # Trigger: Only runs on pull request events
  # Timeout: 10 minutes (dependency review is quick)
  # ============================================================================
  dependency-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4

  # ============================================================================
  # NPM AUDIT JOB
  # ============================================================================
  # Purpose: Scans npm dependencies for known vulnerabilities
  # Timeout: 15 minutes (allows for full dependency tree analysis)
  # Fallback: Uses continue-on-error to allow builds with known vulnerabilities
  # Output: Generates step summary with vulnerability counts
  # ============================================================================
  npm-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: npm ci
      - name: Run npm audit
        id: audit
        run: npm audit --audit-level=high || echo "::warning::Vulnerabilities found. Review npm audit output."
        continue-on-error: true
      - name: Generate audit report
        if: always()
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit.json 2>&1 || true
          if [ -f audit.json ]; then
            TOTAL=$(node -e "const a=require('./audit.json'); console.log(a.metadata?.vulnerabilities?.total || 0)" 2>/dev/null || echo "0")
            CRITICAL=$(node -e "const a=require('./audit.json'); console.log(a.metadata?.vulnerabilities?.critical || 0)" 2>/dev/null || echo "0")
            HIGH=$(node -e "const a=require('./audit.json'); console.log(a.metadata?.vulnerabilities?.high || 0)" 2>/dev/null || echo "0")
            MODERATE=$(node -e "const a=require('./audit.json'); console.log(a.metadata?.vulnerabilities?.moderate || 0)" 2>/dev/null || echo "0")
            LOW=$(node -e "const a=require('./audit.json'); console.log(a.metadata?.vulnerabilities?.low || 0)" 2>/dev/null || echo "0")
            
            echo "### Vulnerability Summary" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL | $([ $CRITICAL -eq 0 ] && echo 'âœ…' || echo 'âŒ BLOCKING') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH | $([ $HIGH -eq 0 ] && echo 'âœ…' || echo 'âš ï¸ Review') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Moderate | $MODERATE | $([ $MODERATE -eq 0 ] && echo 'âœ…' || echo 'â„¹ï¸') |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW | $([ $LOW -eq 0 ] && echo 'âœ…' || echo 'â„¹ï¸') |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** | |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ "$TOTAL" -gt 0 ]; then
              echo "### Remediation" >> $GITHUB_STEP_SUMMARY
              echo "Run \`npm audit fix\` to attempt automatic fixes." >> $GITHUB_STEP_SUMMARY
              echo "For breaking changes: \`npm audit fix --force\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **No vulnerabilities detected!**" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ============================================================================
  # CODEQL JOB
  # ============================================================================
  # Purpose: Performs GitHub CodeQL static analysis for security vulnerabilities
  # Timeout: 360 minutes (CodeQL analysis can be resource-intensive)
  # Security: Requires security-events write permission for SARIF upload
  # Languages: Analyzes JavaScript/TypeScript code
  # Queries: Uses security-extended and security-and-quality query packs
  # ============================================================================
  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript-typescript']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache CodeQL
        uses: actions/cache@v4
        with:
          path: |
            ~/.codeql
            ~/.npm
          key: ${{ runner.os }}-codeql-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-codeql-

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        id: codeql
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true

      - name: Generate CodeQL summary
        if: always()
        run: |
          echo "## ðŸ›¡ï¸ CodeQL Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analysis Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Language | ${{ matrix.language }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Query Packs | security-extended, security-and-quality |" >> $GITHUB_STEP_SUMMARY
          echo "| Config | .github/codeql-config.yml |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.codeql.outcome }}" == "success" ]; then
            echo "âœ… **CodeQL analysis completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Results have been uploaded to the GitHub Security tab." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **CodeQL analysis completed with warnings.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ View detailed results in the [Security tab](../../security/code-scanning)" >> $GITHUB_STEP_SUMMARY
