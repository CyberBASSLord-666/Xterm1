# ============================================================================
# AI Autonomous Agent Workflow for PolliWall (Xterm1)
# ============================================================================
# A master workflow that orchestrates intelligent code improvements using
# static analysis tools and GitHub Copilot integration:
#
# FEATURES:
# - Comprehensive static analysis (ESLint, TypeScript, npm audit)
# - Rule-based prioritization of issues
# - Automatic fixes using standard tools
# - Codebase metrics and pattern detection
# - Security vulnerability scanning
# - GitHub Copilot integration via @copilot mentions for AI assistance
#
# All AI features are powered by GitHub Copilot. No external API keys required.
#
# Prerequisites:
# - None required! Works autonomously out of the box
# - GH_TOKEN for repository access and PR creation (recommended)
#
# Trigger: Workflow dispatch, repository dispatch, or schedule (weekly)
# ============================================================================

name: AI Autonomous Agent

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Agent mode'
        required: true
        type: choice
        options:
          - analyze
          - fix
          - full
        default: 'analyze'
      focus_areas:
        description: 'Focus areas (comma-separated: code-quality,security,performance,architecture)'
        required: false
        type: string
        default: 'code-quality,security,performance'
      auto_commit:
        description: 'Auto-commit fixes'
        required: false
        type: boolean
        default: false
      create_pr:
        description: 'Create PR with changes'
        required: false
        type: boolean
        default: true
      target_branch:
        description: 'Target branch'
        required: false
        type: string

  repository_dispatch:
    types: [ai-agent-requested]

  schedule:
    # Run weekly analysis on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

# Security: Restrict permissions to minimum required
permissions:
  contents: write
  pull-requests: write
  issues: write
  security-events: read

# Security: Prevent concurrent runs
concurrency:
  group: ai-agent-${{ github.run_id }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20'

jobs:
  # ============ COMPREHENSIVE AI ANALYSIS ============
  ai-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      analysis_complete: ${{ steps.analyze.outputs.complete }}
      priority_issues: ${{ steps.prioritize.outputs.issues }}
      recommendations: ${{ steps.analyze.outputs.recommendations }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Collect codebase metrics
        id: metrics
        run: |
          echo "ðŸ“Š Collecting codebase metrics..."
          
          # Code statistics
          TOTAL_TS_FILES=$(find src -name "*.ts" ! -name "*.spec.ts" | wc -l)
          TOTAL_TEST_FILES=$(find src -name "*.spec.ts" | wc -l)
          TOTAL_LINES=$(find src -name "*.ts" -exec wc -l {} + 2>/dev/null | tail -1 | awk '{print $1}')
          
          echo "ts_files=$TOTAL_TS_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TOTAL_TEST_FILES" >> $GITHUB_OUTPUT
          echo "total_lines=$TOTAL_LINES" >> $GITHUB_OUTPUT
          
          # Calculate test coverage ratio
          if [ "$TOTAL_TS_FILES" -gt 0 ]; then
            COVERAGE_RATIO=$((TOTAL_TEST_FILES * 100 / TOTAL_TS_FILES))
          else
            COVERAGE_RATIO=0
          fi
          echo "coverage_ratio=$COVERAGE_RATIO" >> $GITHUB_OUTPUT
          
          # Find large/complex files
          find src -name "*.ts" -size +10k 2>/dev/null | head -10 > /tmp/large-files.txt
          LARGE_FILE_COUNT=$(wc -l < /tmp/large-files.txt)
          echo "large_files=$LARGE_FILE_COUNT" >> $GITHUB_OUTPUT

      - name: Run comprehensive analysis
        id: analyze
        run: |
          echo "ðŸ” Running comprehensive analysis..."
          
          # 1. ESLint analysis
          echo "Running ESLint..."
          set +e
          npx eslint "src/**/*.ts" --format json > /tmp/eslint-full.json 2>&1
          set -e
          
          LINT_ERRORS=$(cat /tmp/eslint-full.json | jq '[.[] | .errorCount] | add // 0')
          LINT_WARNINGS=$(cat /tmp/eslint-full.json | jq '[.[] | .warningCount] | add // 0')
          
          # 2. TypeScript strict analysis
          echo "Running TypeScript analysis..."
          set +e
          npx tsc --noEmit --strict 2>&1 > /tmp/tsc-strict.txt
          set -e
          
          TYPE_ERRORS=$(grep -c "error TS" /tmp/tsc-strict.txt || echo "0")
          
          # 3. Complexity analysis
          echo "Analyzing code complexity..."
          npx eslint "src/**/*.ts" --rule '{"complexity": ["error", 10]}' --format json > /tmp/complexity.json 2>&1 || true
          COMPLEX_COUNT=$(cat /tmp/complexity.json | jq '[.[] | .messages[] | select(.ruleId == "complexity")] | length' 2>/dev/null || echo "0")
          
          # 4. Security scan
          echo "Running security scan..."
          npm audit --json > /tmp/audit.json 2>&1 || true
          SECURITY_VULNS=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.total // 0')
          SECURITY_CRITICAL=$(cat /tmp/audit.json | jq '.metadata.vulnerabilities.critical // 0')
          
          # 5. Dependency analysis
          echo "Analyzing dependencies..."
          npm outdated --json > /tmp/outdated.json 2>&1 || true
          OUTDATED_COUNT=$(cat /tmp/outdated.json | jq 'length' 2>/dev/null || echo "0")
          
          # 6. Code patterns analysis
          echo "Analyzing code patterns..."
          
          ANY_TYPES=$(grep -r ": any" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          CONSOLE_LOGS=$(grep -r "console\." src --include="*.ts" 2>/dev/null | grep -v ".spec." | wc -l || echo "0")
          TODO_COUNT=$(grep -ri "TODO\|FIXME\|HACK\|XXX" src --include="*.ts" 2>/dev/null | wc -l || echo "0")
          
          # Save analysis results
          cat > /tmp/analysis-results.json << EOF
          {
            "lint": {"errors": $LINT_ERRORS, "warnings": $LINT_WARNINGS},
            "types": {"errors": $TYPE_ERRORS},
            "complexity": {"high": $COMPLEX_COUNT},
            "security": {"total": $SECURITY_VULNS, "critical": $SECURITY_CRITICAL},
            "dependencies": {"outdated": $OUTDATED_COUNT},
            "patterns": {
              "anyTypes": $ANY_TYPES,
              "consoleLogs": $CONSOLE_LOGS,
              "todos": $TODO_COUNT
            },
            "metrics": {
              "tsFiles": ${{ steps.metrics.outputs.ts_files }},
              "testFiles": ${{ steps.metrics.outputs.test_files }},
              "coverageRatio": ${{ steps.metrics.outputs.coverage_ratio }},
              "largeFiles": ${{ steps.metrics.outputs.large_files }}
            }
          }
          EOF
          
          echo "complete=true" >> $GITHUB_OUTPUT
          
          # Generate summary
          echo "## ðŸ¤– AI Agent Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint Errors | $LINT_ERRORS | $([ $LINT_ERRORS -eq 0 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Errors | $TYPE_ERRORS | $([ $TYPE_ERRORS -eq 0 ] && echo 'âœ…' || echo 'âŒ') |" >> $GITHUB_STEP_SUMMARY
          echo "| Complex Functions | $COMPLEX_COUNT | $([ $COMPLEX_COUNT -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Vulnerabilities | $SECURITY_VULNS | $([ $SECURITY_VULNS -eq 0 ] && echo 'âœ…' || echo 'ðŸ”´') |" >> $GITHUB_STEP_SUMMARY
          echo "| Outdated Dependencies | $OUTDATED_COUNT | $([ $OUTDATED_COUNT -lt 10 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| 'any' Type Usage | $ANY_TYPES | $([ $ANY_TYPES -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| Console Statements | $CONSOLE_LOGS | $([ $CONSOLE_LOGS -eq 0 ] && echo 'âœ…' || echo 'âš ï¸') |" >> $GITHUB_STEP_SUMMARY
          echo "| TODO Comments | $TODO_COUNT | â„¹ï¸ |" >> $GITHUB_STEP_SUMMARY

      - name: Prioritization (Rule-based)
        id: prioritize
        run: |
          echo "ðŸ§  Prioritizing issues..."
          
          # Read analysis results
          ANALYSIS=$(cat /tmp/analysis-results.json)
          
          # Using rule-based prioritization
          echo "Using rule-based prioritization..."
          
          PRIORITY_LIST="[]"
          
          # Priority 1: Security (Critical)
          CRITICAL=$(echo "$ANALYSIS" | jq '.security.critical')
          if [ "$CRITICAL" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 1, "category": "security", "issue": "Critical vulnerabilities", "count": '"$CRITICAL"', "action": "npm audit fix --force"}]')
          fi
          
          # Priority 2: Type errors
          TYPE_ERR=$(echo "$ANALYSIS" | jq '.types.errors')
          if [ "$TYPE_ERR" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 2, "category": "types", "issue": "Type errors", "count": '"$TYPE_ERR"', "action": "Fix TypeScript errors"}]')
          fi
          
          # Priority 3: Lint errors
          LINT_ERR=$(echo "$ANALYSIS" | jq '.lint.errors')
          if [ "$LINT_ERR" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 3, "category": "lint", "issue": "Lint errors", "count": '"$LINT_ERR"', "action": "eslint --fix"}]')
          fi
          
          # Priority 4: Security (all vulnerabilities)
          SECURITY_TOTAL=$(echo "$ANALYSIS" | jq '.security.total')
          if [ "$SECURITY_TOTAL" -gt 0 ] && [ "$CRITICAL" -eq 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 4, "category": "security", "issue": "Security vulnerabilities", "count": '"$SECURITY_TOTAL"', "action": "npm audit fix"}]')
          fi
          
          # Priority 5: Complexity issues
          COMPLEX=$(echo "$ANALYSIS" | jq '.complexity.high')
          if [ "$COMPLEX" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 5, "category": "complexity", "issue": "High complexity functions", "count": '"$COMPLEX"', "action": "Refactor complex functions"}]')
          fi
          
          # Priority 6: Outdated dependencies
          OUTDATED=$(echo "$ANALYSIS" | jq '.dependencies.outdated')
          if [ "$OUTDATED" -gt 5 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 6, "category": "dependencies", "issue": "Outdated dependencies", "count": '"$OUTDATED"', "action": "npm update"}]')
          fi
          
          # Priority 7: Code patterns (any types)
          ANY_TYPES=$(echo "$ANALYSIS" | jq '.patterns.anyTypes')
          if [ "$ANY_TYPES" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 7, "category": "patterns", "issue": "any type usage", "count": '"$ANY_TYPES"', "action": "Replace any with specific types"}]')
          fi
          
          # Priority 8: Console logs
          CONSOLE_LOGS=$(echo "$ANALYSIS" | jq '.patterns.consoleLogs')
          if [ "$CONSOLE_LOGS" -gt 0 ]; then
            PRIORITY_LIST=$(echo "$PRIORITY_LIST" | jq '. + [{"priority": 8, "category": "patterns", "issue": "Console statements", "count": '"$CONSOLE_LOGS"', "action": "Remove console logs for production"}]')
          fi
          
          echo "$PRIORITY_LIST" > /tmp/priority-list.json
          echo "issues=$(echo $PRIORITY_LIST | jq -c '.')" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload analysis artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-results
          path: |
            /tmp/analysis-results.json
            /tmp/priority-list.json
            /tmp/eslint-full.json
            /tmp/complexity.json
          retention-days: 30
          if-no-files-found: ignore

  # ============ APPLY AI FIXES ============
  ai-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: ai-analysis
    if: (inputs.mode == 'fix' || inputs.mode == 'full') && needs.ai-analysis.outputs.analysis_complete == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch || github.ref }}
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-results
          path: /tmp/

      - name: Apply priority fixes
        id: apply_fixes
        run: |
          echo "ðŸ”§ Applying priority fixes..."
          
          FIXES_LOG=""
          
          # 1. Security fixes (highest priority)
          echo "Applying security fixes..."
          npm audit fix 2>&1 || true
          FIXES_LOG="${FIXES_LOG}\n- âœ… Security: npm audit fix applied"
          
          # 2. ESLint auto-fixes
          echo "Applying ESLint fixes..."
          npx eslint "src/**/*.{ts,html}" --fix 2>&1 || true
          FIXES_LOG="${FIXES_LOG}\n- âœ… Lint: ESLint auto-fix applied"
          
          # 3. Prettier formatting
          echo "Applying Prettier formatting..."
          npx prettier --write "src/**/*.{ts,html,css,scss,json}" 2>&1 || true
          FIXES_LOG="${FIXES_LOG}\n- âœ… Format: Prettier applied"
          
          # 4. Remove console.log (optional based on focus)
          if echo "${{ inputs.focus_areas }}" | grep -q "performance"; then
            echo "Commenting out console.log statements..."
            find src -name "*.ts" ! -name "*.spec.ts" -exec sed -i 's/^\(\s*\)console\.log/\1\/\/ console.log/g' {} \; 2>/dev/null || true
            FIXES_LOG="${FIXES_LOG}\n- âœ… Performance: Console logs commented out"
          fi
          
          echo -e "$FIXES_LOG" > /tmp/fixes-log.txt
          echo "fixes_applied=true" >> $GITHUB_OUTPUT

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            CHANGED_COUNT=$(git status --porcelain | wc -l)
            echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
            git status --porcelain > /tmp/changed-files.txt
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create fix branch
        if: steps.changes.outputs.has_changes == 'true' && inputs.create_pr == true
        id: branch
        run: |
          BRANCH_NAME="ai-agent/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Commit changes
        if: steps.changes.outputs.has_changes == 'true'
        id: commit
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          
          COMMIT_MSG="ðŸ¤– AI Agent: Applied intelligent code improvements

          Mode: ${{ inputs.mode }}
          Focus: ${{ inputs.focus_areas || 'all' }}
          
          Fixes Applied:
          $(cat /tmp/fixes-log.txt)
          
          Files Changed: ${{ steps.changes.outputs.changed_count }}
          
          This commit was automatically generated by the AI Autonomous Agent."
          
          git commit -m "$COMMIT_MSG"
          
          if [ "${{ inputs.create_pr }}" = "true" ]; then
            git push origin ${{ steps.branch.outputs.branch_name }}
          elif [ "${{ inputs.auto_commit }}" = "true" ]; then
            git push
          fi
          
          echo "committed=true" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.commit.outputs.committed == 'true' && inputs.create_pr == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Read fixes log
            let fixesLog = '';
            try {
              if (fs.existsSync('/tmp/fixes-log.txt')) {
                fixesLog = fs.readFileSync('/tmp/fixes-log.txt', 'utf8');
              }
            } catch (e) {
              console.log('No fixes log');
            }
            
            const body = `## ðŸ¤– AI Autonomous Agent - Code Improvements

            This PR contains automatically applied code improvements.

            ### ðŸ“Š Analysis Summary
            The AI Agent analyzed the codebase and identified issues across these areas:
            - **Focus**: ${{ inputs.focus_areas || 'code-quality,security,performance' }}
            - **Mode**: ${{ inputs.mode }}

            ### âœ… Fixes Applied
            ${fixesLog || 'Standard auto-fixes applied'}

            ### ðŸ“ Changes
            - **Files Modified**: ${{ steps.changes.outputs.changed_count }}
            - **Commit**: \`${{ steps.commit.outputs.sha }}\`

            ### Review Guidelines
            1. Verify all changes align with project standards
            2. Run tests to ensure no regressions
            3. Check that security fixes are appropriate
            4. Validate formatting changes

            For AI-powered analysis, use \`@copilot\` to ask questions about the changes.

            ---
            *Generated by AI Autonomous Agent Workflow (GitHub Copilot)*`;
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ¤– AI Agent: Automated code improvements',
              body: body,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: '${{ inputs.target_branch || github.ref_name }}'
            });
            
            console.log(`Created PR #${pr.number}`);
            
            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['ai-generated', 'automated', 'code-quality']
            });
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);

  # ============ GENERATE REPORT ============
  report:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [ai-analysis, ai-fix]
    if: always() && needs.ai-analysis.result != 'cancelled'

    steps:
      - name: Download analysis artifacts
        uses: actions/download-artifact@v4
        with:
          name: ai-analysis-results
          path: /tmp/
        continue-on-error: true

      - name: Generate comprehensive report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Try to read analysis results
            let analysis = {};
            let priorities = [];
            
            try {
              if (fs.existsSync('/tmp/analysis-results.json')) {
                analysis = JSON.parse(fs.readFileSync('/tmp/analysis-results.json', 'utf8'));
              }
            } catch (e) {
              console.log('Could not read analysis results');
            }
            
            try {
              if (fs.existsSync('/tmp/priority-list.json')) {
                const priorityData = JSON.parse(fs.readFileSync('/tmp/priority-list.json', 'utf8'));
                priorities = priorityData.issues || priorityData || [];
              }
            } catch (e) {
              console.log('Could not read priorities');
            }
            
            // Build the report
            let report = `# ðŸ¤– AI Autonomous Agent Report

            **Run Date**: ${new Date().toISOString().split('T')[0]}
            **Mode**: ${{ inputs.mode || 'analyze' }}
            **Focus**: ${{ inputs.focus_areas || 'all' }}

            ## ðŸ“Š Codebase Analysis

            `;
            
            if (Object.keys(analysis).length > 0) {
              report += `### Quality Metrics

            | Category | Metric | Value |
            |----------|--------|-------|
            | **Lint** | Errors | ${analysis.lint?.errors || 0} |
            | **Lint** | Warnings | ${analysis.lint?.warnings || 0} |
            | **Types** | Errors | ${analysis.types?.errors || 0} |
            | **Complexity** | High Complexity Functions | ${analysis.complexity?.high || 0} |
            | **Security** | Vulnerabilities | ${analysis.security?.total || 0} |
            | **Security** | Critical | ${analysis.security?.critical || 0} |
            | **Dependencies** | Outdated | ${analysis.dependencies?.outdated || 0} |

            ### Code Patterns

            | Pattern | Count | Recommendation |
            |---------|-------|----------------|
            | \`any\` Type Usage | ${analysis.patterns?.anyTypes || 0} | Replace with specific types |
            | Console Statements | ${analysis.patterns?.consoleLogs || 0} | Remove for production |
            | TODO Comments | ${analysis.patterns?.todos || 0} | Address or track in issues |

            `;
            }
            
            if (priorities.length > 0) {
              report += `## ðŸŽ¯ Priority Issues

            | Priority | Category | Issue | Action |
            |----------|----------|-------|--------|
            `;
              priorities.slice(0, 10).forEach(p => {
                report += `| ${p.priority} | ${p.category} | ${p.issue} | ${p.recommended_action || p.action || 'Review'} |\n`;
              });
              report += '\n';
            }
            
            report += `## ðŸ”„ Workflow Status

            | Job | Status |
            |-----|--------|
            | Analysis | ${{ needs.ai-analysis.result }} |
            | Fix | ${{ needs.ai-fix.result || 'skipped' }} |

            ---
            *Generated by AI Autonomous Agent (GitHub Copilot) â€¢ [View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;
            
            // Write to job summary
            await core.summary
              .addRaw(report)
              .write();
            
            // If scheduled run, create/update an issue with the report
            if (context.eventName === 'schedule') {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'ai-agent-report',
                per_page: 1
              });
              
              const title = `ðŸ¤– AI Agent Weekly Report - ${new Date().toISOString().split('T')[0]}`;
              
              if (issues.length > 0) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues[0].number,
                  title: title,
                  body: report
                });
              } else {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: report,
                  labels: ['ai-agent-report', 'automated']
                });
              }
            }
