# ============================================================================
# Comment Command Processor for PolliWall (Xterm1)
# ============================================================================
# This workflow processes commands from PR/issue comments and executes
# appropriate actions. It's the interface for human-to-swarm communication.
#
# Supported Commands:
# - @copilot fix lint - Auto-fix lint issues
# - @copilot run tests - Run test suite
# - @copilot check security - Run security scan
# - @copilot apply suggestions - Apply review suggestions
# - @copilot summarize - Summarize PR changes
# - @copilot help - Show available commands
# ============================================================================

name: Comment Command Processor

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  process-command:
    runs-on: ubuntu-latest
    # Only process comments that mention @copilot
    if: contains(github.event.comment.body, '@copilot')
    
    steps:
      - name: Parse command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.toLowerCase();
            
            // Extract command after @copilot
            const match = comment.match(/@copilot\s+(\w+(?:\s+\w+)?)/);
            if (!match) {
              core.setOutput('command', 'help');
              return;
            }
            
            const command = match[1].trim();
            core.setOutput('command', command);
            
            // Determine if this is a PR or issue
            const isPR = !!context.payload.issue.pull_request;
            core.setOutput('is_pr', isPR);
            
            return command;

      - name: Acknowledge command
        uses: actions/github-script@v7
        with:
          script: |
            const command = '${{ steps.parse.outputs.command }}';
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Checkout code
        if: steps.parse.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.pull_request.head.ref || github.head_ref }}
          # Use GH_TOKEN to enable pushing commits and triggering other workflows
          # Falls back to GITHUB_TOKEN if GH_TOKEN is not configured
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.parse.outputs.is_pr == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.parse.outputs.is_pr == 'true'
        run: npm ci

      # ============ HELP COMMAND ============
      - name: Handle help command
        if: steps.parse.outputs.command == 'help'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ Agentic Swarm Commands

            Here are the available commands:

            | Command | Description |
            |---------|-------------|
            | \`@copilot help\` | Show this help message |
            | \`@copilot fix all\` | **NEW!** Fix everything: lint, security, formatting |
            | \`@copilot fix lint\` | Auto-fix ESLint and Prettier issues |
            | \`@copilot fix security\` | Auto-fix npm audit vulnerabilities |
            | \`@copilot run tests\` | Run the test suite |
            | \`@copilot check security\` | Run security vulnerability scan |
            | \`@copilot apply suggestions\` | Apply pending review suggestions |
            | \`@copilot summarize\` | Generate a summary of PR changes |
            | \`@copilot status\` | Show swarm status for this PR |
            
            ### üîß Refactoring Commands
            | Command | Description |
            |---------|-------------|
            | \`@copilot refactor\` | General code refactoring |
            | \`@copilot modernize\` | Modernize code patterns |
            | \`@copilot optimize\` | Performance optimization |
            | \`@copilot simplify\` | Reduce code complexity |
            | \`@copilot extract [type] [name] from [file]\` | Extract code to module |

            **Usage:** Just comment with one of the commands above and I'll handle it!

            ---
            *Agentic Swarm Command Processor*`
            });

      # ============ FIX LINT COMMAND ============
      - name: Handle fix lint command
        if: steps.parse.outputs.command == 'fix lint' && steps.parse.outputs.is_pr == 'true'
        id: fix_lint
        run: |
          npx eslint "src/**/*.{ts,html}" --fix || true
          npx prettier --write "src/**/*.{ts,html,css,scss,json}" || true
          
          if [[ -n $(git status --porcelain) ]]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add -A
            git commit -m "ü§ñ Fix: Applied lint and formatting corrections per @${{ github.event.comment.user.login }} request"
            git push
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Report lint fix results
        if: steps.parse.outputs.command == 'fix lint'
        uses: actions/github-script@v7
        with:
          script: |
            const fixed = '${{ steps.fix_lint.outputs.fixed }}' === 'true';
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            
            let message;
            if (!isPR) {
              message = '‚ö†Ô∏è This command only works on pull requests.';
            } else if (fixed) {
              message = '‚úÖ **Lint Fixed!** ESLint and Prettier corrections have been applied and committed.';
            } else {
              message = '‚ú® **No Changes Needed** - The code is already properly formatted.';
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            // Add success reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: fixed ? 'rocket' : 'thumbs_up'
            });

      # ============ RUN TESTS COMMAND ============
      - name: Handle run tests command
        if: steps.parse.outputs.command == 'run tests' && steps.parse.outputs.is_pr == 'true'
        id: run_tests
        run: |
          npm test -- --coverage --watchAll=false > test-output.txt 2>&1 || true
          
          # Extract summary
          PASSED=$(grep -oP 'Tests:\s+\K\d+(?=\s+passed)' test-output.txt || echo "0")
          FAILED=$(grep -oP 'Tests:\s+\d+\s+failed,\s+\K\d+' test-output.txt || echo "0")
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
          if [ "$FAILED" = "0" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Report test results
        if: steps.parse.outputs.command == 'run tests'
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '‚ö†Ô∏è This command only works on pull requests.'
              });
              return;
            }
            
            const passed = '${{ steps.run_tests.outputs.passed }}';
            const failed = '${{ steps.run_tests.outputs.failed }}';
            const status = '${{ steps.run_tests.outputs.status }}';
            
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${emoji} Test Results

            | Metric | Value |
            |--------|-------|
            | Passed | ${passed} |
            | Failed | ${failed} |
            | Status | ${status} |

            ${status === 'failure' ? '‚ö†Ô∏è Some tests failed. Please review the test output.' : '‚ú® All tests passed!'}

            ---
            *Executed by Swarm Test Orchestrator*`
            });

      # ============ CHECK SECURITY COMMAND ============
      - name: Handle check security command
        if: steps.parse.outputs.command == 'check security' && steps.parse.outputs.is_pr == 'true'
        id: security
        run: |
          npm audit --json > audit.json 2>&1 || true
          
          CRITICAL=$(cat audit.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat audit.json | jq '.metadata.vulnerabilities.low // 0')
          TOTAL=$(cat audit.json | jq '.metadata.vulnerabilities.total // 0')
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Report security results
        if: steps.parse.outputs.command == 'check security'
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '‚ö†Ô∏è This command only works on pull requests.'
              });
              return;
            }
            
            const critical = '${{ steps.security.outputs.critical }}';
            const high = '${{ steps.security.outputs.high }}';
            const moderate = '${{ steps.security.outputs.moderate }}';
            const low = '${{ steps.security.outputs.low }}';
            const total = '${{ steps.security.outputs.total }}';
            
            const hasCritical = parseInt(critical) > 0 || parseInt(high) > 0;
            const emoji = total === '0' ? '‚úÖ' : (hasCritical ? 'üö®' : '‚ö†Ô∏è');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${emoji} Security Scan Results

            | Severity | Count |
            |----------|-------|
            | üî¥ Critical | ${critical} |
            | üü† High | ${high} |
            | üü° Moderate | ${moderate} |
            | üü¢ Low | ${low} |
            | **Total** | **${total}** |

            ${total === '0' 
              ? '‚ú® No vulnerabilities found!' 
              : (hasCritical 
                ? 'üö® **Action Required:** Critical/high vulnerabilities detected. Run \`npm audit fix\` or review manually.'
                : '‚ö†Ô∏è Some vulnerabilities found. Consider running \`npm audit fix\`.'
              )
            }

            ---
            *Executed by Swarm Security Guardian*`
            });

      # ============ SUMMARIZE COMMAND ============
      - name: Handle summarize command
        if: steps.parse.outputs.command == 'summarize' && steps.parse.outputs.is_pr == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Categorize files
            const categories = {
              components: files.filter(f => f.filename.includes('.component.')),
              services: files.filter(f => f.filename.includes('.service.')),
              tests: files.filter(f => f.filename.includes('.spec.')),
              styles: files.filter(f => f.filename.match(/\.(css|scss)$/)),
              docs: files.filter(f => f.filename.match(/\.(md|txt)$/)),
              config: files.filter(f => f.filename.match(/\.(json|yml|yaml)$/)),
              other: []
            };
            
            // Calculate other
            const categorized = new Set([
              ...categories.components,
              ...categories.services,
              ...categories.tests,
              ...categories.styles,
              ...categories.docs,
              ...categories.config
            ].map(f => f.filename));
            
            categories.other = files.filter(f => !categorized.has(f.filename));
            
            const summary = `## üìã PR Summary

            **${pr.title}**

            ### Statistics
            | Metric | Value |
            |--------|-------|
            | Files Changed | ${files.length} |
            | Additions | +${pr.additions} |
            | Deletions | -${pr.deletions} |
            | Commits | ${pr.commits} |

            ### Files by Category
            | Category | Count | Files |
            |----------|-------|-------|
            | Components | ${categories.components.length} | ${categories.components.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Services | ${categories.services.length} | ${categories.services.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Tests | ${categories.tests.length} | ${categories.tests.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Styles | ${categories.styles.length} | ${categories.styles.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Documentation | ${categories.docs.length} | ${categories.docs.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Config | ${categories.config.length} | ${categories.config.map(f => f.filename.split('/').pop()).join(', ') || '-'} |
            | Other | ${categories.other.length} | ${categories.other.map(f => f.filename.split('/').pop()).join(', ') || '-'} |

            ---
            *Generated by Swarm Coordinator*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

      # ============ STATUS COMMAND ============
      - name: Handle status command
        if: steps.parse.outputs.command == 'status'
        uses: actions/github-script@v7
        with:
          script: |
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            
            if (!isPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## ü§ñ Swarm Status

            **Issue Mode** - Limited functionality available.

            For full swarm capabilities, use commands on pull requests.

            ---
            *Agentic Swarm Status*`
              });
              return;
            }
            
            // Get check runs for the PR
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const checks = checkRuns.check_runs.map(c => ({
              name: c.name,
              status: c.status,
              conclusion: c.conclusion
            }));
            
            const getEmoji = (conclusion) => {
              if (conclusion === 'success') return '‚úÖ';
              if (conclusion === 'failure') return '‚ùå';
              if (conclusion === 'neutral') return '‚ö™';
              if (conclusion === 'skipped') return '‚è≠Ô∏è';
              return 'üîÑ';
            };
            
            const checksList = checks.map(c => 
              `| ${c.name} | ${getEmoji(c.conclusion)} | ${c.conclusion || c.status} |`
            ).join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ü§ñ Swarm Status

            ### CI/CD Checks
            | Check | Status | Result |
            |-------|--------|--------|
            ${checksList || '| No checks found | ‚ö™ | - |'}

            ### Available Actions
            - \`@copilot fix all\` - Fix everything (lint, security, formatting)
            - \`@copilot fix lint\` - Fix code style issues
            - \`@copilot fix security\` - Fix npm audit vulnerabilities
            - \`@copilot run tests\` - Run test suite
            - \`@copilot check security\` - Security scan
            - \`@copilot summarize\` - PR summary

            ---
            *Agentic Swarm Status*`
            });

      # ============ FIX ALL COMMAND ============
      - name: Handle fix all command
        if: steps.parse.outputs.command == 'fix all' && steps.parse.outputs.is_pr == 'true'
        id: fix_all
        run: |
          echo "üîß Starting comprehensive fix: lint, security, and formatting..."
          
          FIXES_APPLIED=""
          
          # 1. Fix ESLint issues
          echo "üìù Running ESLint auto-fix..."
          if npx eslint "src/**/*.{ts,html}" --fix 2>&1; then
            FIXES_APPLIED="$FIXES_APPLIED\n- ‚úÖ ESLint: Auto-fixed issues"
          else
            FIXES_APPLIED="$FIXES_APPLIED\n- ‚ö†Ô∏è ESLint: Some issues may require manual attention"
          fi
          
          # 2. Fix Prettier formatting
          echo "üé® Running Prettier..."
          if npx prettier --write "src/**/*.{ts,html,css,scss,json}" 2>&1; then
            FIXES_APPLIED="$FIXES_APPLIED\n- ‚úÖ Prettier: Code formatted"
          else
            FIXES_APPLIED="$FIXES_APPLIED\n- ‚ö†Ô∏è Prettier: Some formatting issues remain"
          fi
          
          # 3. Fix security vulnerabilities
          echo "üîí Running npm audit fix..."
          npm audit --json > audit-before.json 2>&1 || true
          VULNS_BEFORE=$(cat audit-before.json | jq '.metadata.vulnerabilities.total // 0')
          
          if npm audit fix 2>&1; then
            npm audit --json > audit-after.json 2>&1 || true
            VULNS_AFTER=$(cat audit-after.json | jq '.metadata.vulnerabilities.total // 0')
            
            if [[ "$VULNS_BEFORE" != "$VULNS_AFTER" ]]; then
              FIXED_COUNT=$((VULNS_BEFORE - VULNS_AFTER))
              FIXES_APPLIED="$FIXES_APPLIED\n- ‚úÖ Security: Fixed $FIXED_COUNT of $VULNS_BEFORE vulnerabilities"
            else
              FIXES_APPLIED="$FIXES_APPLIED\n- ‚ö™ Security: No auto-fixable vulnerabilities"
            fi
          else
            FIXES_APPLIED="$FIXES_APPLIED\n- ‚ö†Ô∏è Security: npm audit fix encountered issues"
          fi
          
          echo "vulns_before=$VULNS_BEFORE" >> $GITHUB_OUTPUT
          echo "vulns_after=$VULNS_AFTER" >> $GITHUB_OUTPUT
          
          # Check for changes and commit
          if [[ -n $(git status --porcelain) ]]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add -A
            git commit -m "ü§ñ Fix All: Applied comprehensive fixes per @${{ github.event.comment.user.login }} request

          Fixes applied:
          - ESLint auto-fix
          - Prettier formatting
          - npm audit fix (security)
          
          This commit was automatically generated by the Agentic Swarm."
            git push
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi
          
          echo -e "$FIXES_APPLIED" > fixes-applied.txt

      - name: Report fix all results
        if: steps.parse.outputs.command == 'fix all'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const fixed = '${{ steps.fix_all.outputs.fixed }}' === 'true';
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            const vulnsBefore = '${{ steps.fix_all.outputs.vulns_before }}' || '0';
            const vulnsAfter = '${{ steps.fix_all.outputs.vulns_after }}' || '0';
            
            let fixesApplied = '- See details above';
            if (fs.existsSync('fixes-applied.txt')) {
              fixesApplied = fs.readFileSync('fixes-applied.txt', 'utf8');
            }
            
            let message;
            if (!isPR) {
              message = '‚ö†Ô∏è This command only works on pull requests.';
            } else if (fixed) {
              message = `## ‚úÖ Fix All Complete

            The Agentic Swarm has applied comprehensive fixes to your PR.

            ### Fixes Applied
            ${fixesApplied}

            ### Security Summary
            | Metric | Value |
            |--------|-------|
            | Vulnerabilities Before | ${vulnsBefore} |
            | Vulnerabilities After | ${vulnsAfter} |
            | Fixed | ${parseInt(vulnsBefore) - parseInt(vulnsAfter)} |

            All changes have been committed and pushed.

            ---
            *Agentic Swarm - Fix All Complete*`;
            } else {
              message = `## ‚ú® No Changes Needed

            The code is already in great shape! No fixes were necessary.

            - ‚úÖ ESLint: No issues
            - ‚úÖ Prettier: Already formatted
            - ‚úÖ Security: ${vulnsBefore === '0' ? 'No vulnerabilities' : `${vulnsBefore} vulnerabilities (none auto-fixable)`}

            ---
            *Agentic Swarm - Fix All Complete*`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: fixed ? 'rocket' : 'thumbs_up'
            });

      # ============ FIX SECURITY COMMAND ============
      - name: Handle fix security command
        if: steps.parse.outputs.command == 'fix security' && steps.parse.outputs.is_pr == 'true'
        id: fix_security
        run: |
          echo "üîí Starting security vulnerability auto-fix..."
          
          # Get current vulnerability count
          npm audit --json > audit-before.json 2>&1 || true
          VULNS_BEFORE=$(cat audit-before.json | jq '.metadata.vulnerabilities.total // 0')
          CRITICAL_BEFORE=$(cat audit-before.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_BEFORE=$(cat audit-before.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "vulns_before=$VULNS_BEFORE" >> $GITHUB_OUTPUT
          echo "critical_before=$CRITICAL_BEFORE" >> $GITHUB_OUTPUT
          echo "high_before=$HIGH_BEFORE" >> $GITHUB_OUTPUT
          
          # Attempt auto-fix
          npm audit fix 2>&1 | tee audit-fix-output.txt || true
          
          # Get new vulnerability count
          npm audit --json > audit-after.json 2>&1 || true
          VULNS_AFTER=$(cat audit-after.json | jq '.metadata.vulnerabilities.total // 0')
          CRITICAL_AFTER=$(cat audit-after.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_AFTER=$(cat audit-after.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "vulns_after=$VULNS_AFTER" >> $GITHUB_OUTPUT
          echo "critical_after=$CRITICAL_AFTER" >> $GITHUB_OUTPUT
          echo "high_after=$HIGH_AFTER" >> $GITHUB_OUTPUT
          
          # Check for changes
          if [[ -n $(git status --porcelain package.json package-lock.json 2>/dev/null) ]]; then
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add package.json package-lock.json
            git commit -m "üîí Security: Auto-fix vulnerabilities per @${{ github.event.comment.user.login }} request

          Before: $VULNS_BEFORE vulnerabilities ($CRITICAL_BEFORE critical, $HIGH_BEFORE high)
          After: $VULNS_AFTER vulnerabilities ($CRITICAL_AFTER critical, $HIGH_AFTER high)
          
          This commit was automatically generated by the Swarm Security Guardian."
            git push
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi

      - name: Report fix security results
        if: steps.parse.outputs.command == 'fix security'
        uses: actions/github-script@v7
        with:
          script: |
            const fixed = '${{ steps.fix_security.outputs.fixed }}' === 'true';
            const isPR = '${{ steps.parse.outputs.is_pr }}' === 'true';
            const vulnsBefore = '${{ steps.fix_security.outputs.vulns_before }}' || '0';
            const vulnsAfter = '${{ steps.fix_security.outputs.vulns_after }}' || '0';
            const criticalBefore = '${{ steps.fix_security.outputs.critical_before }}' || '0';
            const criticalAfter = '${{ steps.fix_security.outputs.critical_after }}' || '0';
            const highBefore = '${{ steps.fix_security.outputs.high_before }}' || '0';
            const highAfter = '${{ steps.fix_security.outputs.high_after }}' || '0';
            
            let message;
            if (!isPR) {
              message = '‚ö†Ô∏è This command only works on pull requests.';
            } else if (fixed) {
              const fixedCount = parseInt(vulnsBefore) - parseInt(vulnsAfter);
              message = `## üîí Security Fix Complete

            The Swarm Security Guardian has automatically fixed vulnerabilities.

            ### Summary
            | Severity | Before | After | Fixed |
            |----------|--------|-------|-------|
            | üî¥ Critical | ${criticalBefore} | ${criticalAfter} | ${parseInt(criticalBefore) - parseInt(criticalAfter)} |
            | üü† High | ${highBefore} | ${highAfter} | ${parseInt(highBefore) - parseInt(highAfter)} |
            | **Total** | **${vulnsBefore}** | **${vulnsAfter}** | **${fixedCount}** |

            ${parseInt(vulnsAfter) > 0 ? `### ‚ö†Ô∏è Remaining Vulnerabilities

            ${vulnsAfter} vulnerabilities could not be auto-fixed. Consider:
            1. \`npm audit fix --force\` for breaking changes
            2. Manual dependency updates
            3. Finding alternative packages` : '### ‚úÖ All Vulnerabilities Resolved!'}

            ---
            *Swarm Security Guardian - Fix Complete*`;
            } else if (vulnsBefore === '0') {
              message = `## ‚úÖ No Vulnerabilities

            No security vulnerabilities were found in your dependencies!

            ---
            *Swarm Security Guardian*`;
            } else {
              message = `## ‚ö†Ô∏è No Auto-Fixable Vulnerabilities

            Found **${vulnsBefore}** vulnerabilities but none could be automatically fixed.

            | Severity | Count |
            |----------|-------|
            | üî¥ Critical | ${criticalBefore} |
            | üü† High | ${highBefore} |

            ### Recommended Actions
            1. Run \`npm audit fix --force\` locally (may include breaking changes)
            2. Manually update vulnerable packages
            3. Check for alternative packages

            ---
            *Swarm Security Guardian*`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: fixed ? 'rocket' : (vulnsBefore === '0' ? 'heart' : 'thumbs_up')
            });
