# ============================================================================
# Stale Issues and PRs Management Workflow for PolliWall (Xterm1)
# ============================================================================
# This workflow automatically manages stale issues and pull requests to keep
# the repository clean and organized.
#
# Behavior:
# - Issues: Marked stale after 60 days of inactivity, closed after 7 more days
# - PRs: Marked stale after 30 days of inactivity, closed after 14 more days
# - Exemptions: Important labels (bug, security, etc.) are never marked stale
#
# Enterprise Features:
# - Separate configurations for issues and PRs
# - Label-based exemptions for important work
# - Informative messages explaining the stale process
# - Operations limits to prevent rate limiting
# - Comprehensive step summaries
#
# Schedule: Runs daily at 2:00 AM UTC
#
# NOTES:
# - This workflow does NOT affect issues/PRs with exempt labels
# - Maintainers can prevent closure by removing the stale label
# - Closed items can be reopened if they become relevant again
# ============================================================================

name: Stale Issues and PRs

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      debug-only:
        description: 'Run in debug mode (no changes)'
        required: false
        type: boolean
        default: false
      close-issues:
        description: 'Actually close stale issues'
        required: false
        type: boolean
        default: true
      close-prs:
        description: 'Actually close stale PRs'
        required: false
        type: boolean
        default: true

# Security: Minimal permissions required for stale management
permissions:
  issues: write
  pull-requests: write

# Concurrency: Only one stale run at a time
concurrency:
  group: stale-management
  cancel-in-progress: false

jobs:
  # ============================================================================
  # STALE MANAGEMENT JOB
  # ============================================================================
  # Purpose: Marks and closes stale issues and PRs
  # Timeout: 30 minutes (processing many items can take time)
  # Operations Limit: 100 per run to prevent rate limiting
  # ============================================================================
  stale:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Manage stale issues and PRs
        uses: actions/stale@v9
        id: stale
        with:
          # ============ ISSUES CONFIGURATION ============
          # Mark issues stale after 60 days of inactivity
          days-before-issue-stale: 60
          # Close stale issues after 7 days with no activity
          days-before-issue-close: 7
          # Label to apply to stale issues
          stale-issue-label: 'stale'
          # Label to apply when closing stale issues
          close-issue-label: 'closed-stale'
          # Message to post when marking an issue as stale
          stale-issue-message: |
            ## â° This issue has been marked as stale
            
            This issue has been automatically marked as stale because it has not had any activity in the last **60 days**. It will be closed in **7 days** if no further activity occurs.
            
            ### What you can do:
            - ðŸ“ **Add a comment** to keep this issue open
            - ðŸ·ï¸ **Add a priority label** to exempt it from staleness
            - âœ… **Close it** if it's no longer relevant
            
            ### Why this happens:
            Stale issues are automatically managed to keep the repository organized and focused on active work. This doesn't mean your issue isn't important â€“ simply add a comment to reactivate it!
            
            ---
            *This action was performed automatically by the Stale Bot.*
          # Message to post when closing a stale issue
          close-issue-message: |
            ## ðŸ”’ This issue has been closed
            
            This issue has been automatically closed because it remained stale for **7 days** after being marked.
            
            ### Not resolved?
            If this issue is still relevant, please feel free to:
            - ðŸ”„ **Reopen this issue** with additional context
            - ðŸ†• **Create a new issue** if circumstances have changed
            
            Thank you for your contributions to PolliWall!
            
            ---
            *This action was performed automatically by the Stale Bot.*

          # ============ PR CONFIGURATION ============
          # Mark PRs stale after 30 days of inactivity
          days-before-pr-stale: 30
          # Close stale PRs after 14 days with no activity
          days-before-pr-close: 14
          # Label to apply to stale PRs
          stale-pr-label: 'stale'
          # Label to apply when closing stale PRs
          close-pr-label: 'closed-stale'
          # Message to post when marking a PR as stale
          stale-pr-message: |
            ## â° This pull request has been marked as stale
            
            This PR has been automatically marked as stale because it has not had any activity in the last **30 days**. It will be closed in **14 days** if no further activity occurs.
            
            ### What you can do:
            - ðŸ“ **Add a comment** or push new commits to keep this PR open
            - ðŸ”„ **Rebase on main** if there are conflicts
            - âœ… **Request a review** if it's ready
            - ðŸ—‘ï¸ **Close it** if it's no longer needed
            
            ### Common reasons for stale PRs:
            - Waiting for review feedback
            - Work in progress that got deprioritized
            - Blocked by other changes
            
            If you need more time, just add a comment explaining the situation!
            
            ---
            *This action was performed automatically by the Stale Bot.*
          # Message to post when closing a stale PR
          close-pr-message: |
            ## ðŸ”’ This pull request has been closed
            
            This PR has been automatically closed because it remained stale for **14 days** after being marked.
            
            ### Want to continue this work?
            - ðŸ”„ **Reopen this PR** if you'd like to continue
            - ðŸ†• **Create a new PR** with fresh changes
            
            We appreciate your contribution and hope to see it completed!
            
            ---
            *This action was performed automatically by the Stale Bot.*

          # ============ EXEMPTIONS ============
          # Labels that prevent issues from being marked stale
          exempt-issue-labels: |
            bug
            security
            enhancement
            priority: critical
            priority: high
            blocked
            help wanted
            good first issue
            discussion
            wontfix
            pinned
            in-progress
          # Labels that prevent PRs from being marked stale
          exempt-pr-labels: |
            bug
            security
            priority: critical
            priority: high
            blocked
            work-in-progress
            wip
            do-not-close
            pinned
            dependencies
          # Exempt issues and PRs with assignees
          exempt-all-assignees: true
          # Exempt issues and PRs with milestones
          exempt-all-milestones: true

          # ============ OPERATIONS ============
          # Maximum number of operations per run (to avoid rate limits)
          operations-per-run: 100
          # Remove stale label when issues/PRs are updated
          remove-stale-when-updated: true
          # Delete branch when closing stale PR (disabled for safety)
          delete-branch: false
          # Enable debug mode from input
          debug-only: ${{ inputs.debug-only || 'false' }}
          # Use ascending order to process oldest first
          ascending: true
          
      - name: Generate stale summary
        if: always()
        run: |
          echo "## ðŸ§¹ Stale Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Stale After | Close After | Total Days |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------------|-------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Issues | 60 days | 7 days | 67 days |" >> $GITHUB_STEP_SUMMARY
          echo "| Pull Requests | 30 days | 14 days | 44 days |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Exempt Labels" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following labels prevent issues/PRs from being marked stale:" >> $GITHUB_STEP_SUMMARY
          echo "- \`bug\`, \`security\`, \`enhancement\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`priority: critical\`, \`priority: high\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`blocked\`, \`help wanted\`, \`good first issue\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`work-in-progress\`, \`wip\`, \`do-not-close\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`pinned\`, \`dependencies\`, \`discussion\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Exemptions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Issues/PRs with assignees are exempt" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Issues/PRs with milestones are exempt" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Run completed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
