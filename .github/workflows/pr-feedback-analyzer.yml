# ============================================================================
# PR Feedback Analyzer & Auto-Applier for PolliWall (Xterm1)
# ============================================================================
# This workflow analyzes PR review comments and suggestions, and can
# automatically apply accepted suggestions or create issues for complex changes.
#
# Features:
# - Analyzes PR review comments using GitHub's suggestion format
# - Auto-applies single-line suggestions when approved
# - Creates follow-up issues for complex feedback
# - Summarizes actionable feedback for PR authors
# ============================================================================

name: PR Feedback Analyzer

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze-feedback:
    runs-on: ubuntu-latest
    # Only run on PR comments (not issue comments)
    if: github.event.issue.pull_request || github.event.pull_request
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.head_ref }}
          # Use GH_TOKEN to enable pushing commits and triggering other workflows
          # Falls back to GITHUB_TOKEN if GH_TOKEN is not configured
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Analyze review feedback
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            if (!prNumber) {
              console.log('No PR number found, skipping analysis');
              return;
            }
            
            // Get all review comments
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: prNumber,
            });
            
            // Categorize feedback
            const suggestions = [];
            const actionItems = [];
            const questions = [];
            
            for (const comment of reviewComments) {
              const body = comment.body || '';
              
              // Check for GitHub suggestion format
              if (body.includes('```suggestion')) {
                suggestions.push({
                  id: comment.id,
                  path: comment.path,
                  line: comment.line || comment.original_line,
                  suggestion: body,
                  author: comment.user.login
                });
              }
              // Check for action items (keywords)
              else if (body.toLowerCase().match(/\b(fix|change|update|remove|add|refactor|should|must|need to)\b/)) {
                actionItems.push({
                  id: comment.id,
                  path: comment.path,
                  body: body,
                  author: comment.user.login
                });
              }
              // Check for questions
              else if (body.includes('?')) {
                questions.push({
                  id: comment.id,
                  body: body,
                  author: comment.user.login
                });
              }
            }
            
            // Output summary
            core.setOutput('suggestions_count', suggestions.length);
            core.setOutput('action_items_count', actionItems.length);
            core.setOutput('questions_count', questions.length);
            core.setOutput('has_feedback', (suggestions.length + actionItems.length + questions.length) > 0);
            
            // Store for later steps
            return {
              suggestions,
              actionItems,
              questions,
              prNumber
            };

      - name: Post feedback summary
        if: steps.analyze.outputs.has_feedback == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number || context.payload.issue?.number;
            
            const suggestionsCount = '${{ steps.analyze.outputs.suggestions_count }}';
            const actionItemsCount = '${{ steps.analyze.outputs.action_items_count }}';
            const questionsCount = '${{ steps.analyze.outputs.questions_count }}';
            
            // Only post if there's meaningful feedback to summarize
            if (parseInt(suggestionsCount) + parseInt(actionItemsCount) > 0) {
              const body = `## üìä PR Feedback Analysis

            I've analyzed the review feedback on this PR:

            | Category | Count | Status |
            |----------|-------|--------|
            | üí° Code Suggestions | ${suggestionsCount} | Ready to apply |
            | ‚úÖ Action Items | ${actionItemsCount} | Needs attention |
            | ‚ùì Questions | ${questionsCount} | Needs response |

            ### Quick Actions

            ${parseInt(suggestionsCount) > 0 ? '- **Apply suggestions**: Use GitHub\'s "Apply suggestion" button on each suggestion, or comment \`@copilot apply suggestions\` to apply all.' : ''}
            ${parseInt(actionItemsCount) > 0 ? '- **Address action items**: Review the flagged comments and make the requested changes.' : ''}
            ${parseInt(questionsCount) > 0 ? '- **Answer questions**: Reviewers have questions that need responses.' : ''}

            ---
            *This analysis was automatically generated by the PR Feedback Analyzer.*`;

              // Check if we already posted a summary (avoid duplicates)
              const { data: comments } = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: prNumber,
              });
              
              const existingSummary = comments.find(c => 
                c.user.login === 'github-actions[bot]' && 
                c.body.includes('PR Feedback Analysis')
              );
              
              if (!existingSummary) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: prNumber,
                  body
                });
              }
            }

  apply-suggestions:
    runs-on: ubuntu-latest
    # Trigger on specific command comment
    if: |
      github.event_name == 'issue_comment' && 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@copilot apply suggestions')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.issue.pull_request.head.ref }}
          # Use GH_TOKEN to enable pushing commits and triggering other workflows
          # Falls back to GITHUB_TOKEN if GH_TOKEN is not configured
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Apply pending suggestions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            
            // Get all review comments with suggestions
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner,
              repo,
              pull_number: prNumber,
            });
            
            const suggestions = reviewComments.filter(c => c.body?.includes('```suggestion'));
            
            if (suggestions.length === 0) {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: '‚ö†Ô∏è No pending suggestions found to apply.'
              });
              return;
            }
            
            // Note: Actual suggestion application requires GitHub API support
            // For now, we list what would be applied
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: `## üìã Suggestions Ready to Apply

            Found **${suggestions.length}** suggestion(s) in the review comments.

            To apply these suggestions:
            1. Go to each suggestion in the "Files changed" tab
            2. Click "Apply suggestion" or "Add suggestion to batch"
            3. Commit the batch when ready

            *Note: GitHub's suggestion API requires manual approval for security reasons.*`
            });
